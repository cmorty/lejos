<!-- build file for building the os dependent parts of the lejos distribution -->
<!-- do not change this file -->

<project name="leJOS distribution" default="build" basedir=".">
	
	<!-- Setting up the global properties for the build -->
	<property name="lejos.dist.root" value="${basedir}/.."/>
	<property name="lejos.dist.bin" value="${lejos.dist.root}/bin"/>
	<property name="lejos.dist.3rdparty.libs" value="../3rdparty/lib"/>
	<property name="lejos.dist.src" value="${lejos.dist.root}/src"/>
	<property name="plat.unix.src" value="${lejos.dist.src}/nxtvm/platform/unix"/>
	<property name="javavm.src" value="${lejos.dist.src}/nxtvm/javavm"/>
	
	<!-- cpptasks task & type def -->
	<taskdef resource="cpptasks.tasks">
	  <classpath>
	    <pathelement location="${lejos.dist.3rdparty.libs}/cpptasks.jar"/>
	  </classpath>
	</taskdef>
	<typedef resource="cpptasks.types">
	  <classpath>
	    <pathelement location="${lejos.dist.3rdparty.libs}/cpptasks.jar"/>
	  </classpath>
	</typedef>
	
	<!-- build the os dependent parts of the lejos distribution --> 
	<target name="build" depends ="clean,libnxt, jbluez, emulator, copy.binaries, clear" 
		description="build the os dependent parts of the lejos distribution">
		<echo message="Done."/>
	</target>

  	<!-- cleans the os dependent parts of the lejos distribution -->
	<target name="clean" description="cleans the os dependent parts of the lejos distribution">
	    <!-- move existing files to *.bak -->
		<echo message="saving existing files to .bak files"/>
		<move todir="${lejos.dist.bin}">
			<fileset dir="${lejos.dist.bin}">
				<include name="emu-*"/>	
				<include name="nxjflash"/>
				<include name="runc"/>
				<include name="*.so"/>
		      	<exclude name="*.bak"/>
		    </fileset>
		    <mapper type="glob" from="*" to="*.bak"/>
		</move>
  	</target>
  	
  	<!-- clears the transient artifacts generated by the build -->
	<target name="clear" description="clears the transient artifacts generated by the build">
		<delete>
			<fileset dir="${lejos.dist.bin}">
				<include name="*.xml"/>	
		    </fileset>
		</delete>
  	</target>

	<!-- builds the emulator -->
  	<target name="emulator" description="builds the emulator">
  		<ant antfile="${plat.unix.src}/build.xml" dir="${plat.unix.src}" inheritall="true" />
  	</target>
  		
	<!-- builds libnxt -->
  	<target name="libnxt" description="builds libnxt">
  		<ant antfile="${lejos.dist.src}/libnxt/build.xml" dir="${lejos.dist.src}/libnxt" inheritall="true" />
  	</target>
  	
     <condition property="isMacOs">
	      <os family="mac"/>
	  </condition>

	<!-- builds jbluez -->
  	<target name="jbluez" description="builds jbluez"  unless="isMacOs">
  		<ant antfile="${lejos.dist.src}/jbluez/build.xml" dir="${lejos.dist.src}/jbluez" inheritall="true" />
  	</target>
	
	<!-- copies the binaries -->
	<target name="copy.binaries" description="copies runjava and emu-lejosrun">
		<copy todir="${lejos.dist.bin}">
      		<fileset dir="${lejos.dist.src}/libnxt">
        		<include name="runc"/>
      			<include name="nxjflash"/>
      			<include name="libjlibnxt.so"/>
      			<include name="libjlibnxt.dylib"/>
      		</fileset>
		</copy>
		
		<copy todir="${lejos.dist.bin}">
      		<fileset dir="${lejos.dist.src}/jbluez">
      			<include name="libjbluez.so"/>
      		</fileset>
		</copy>
		
		<copy todir="${lejos.dist.bin}">
      		<fileset dir="${lejos.dist.src}/nxtvm/platform/unix">
        		<include name="emu-lejosrun"/>
      		</fileset>
		</copy>
		
		<!-- adjust permissions -->
  		<chmod perm="755">
  			<fileset dir="${lejos.dist.bin}">
  	      	</fileset>
  		</chmod>
	</target>
</project>
